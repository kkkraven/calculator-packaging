import { Hono } from 'hono';
import { cors } from 'hono/cors';
import { GoogleGenerativeAI } from '@google/generative-ai';
import { KNOWLEDGE_BASE_STRUCTURE_PROMPT, PRICING_RULES_PROMPT, DIALOG_EXAMPLE } from './prompts.js';

// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚ (Ñ€Ð°Ð½ÐµÐµ Ð² constants.ts)
const PRODUCT_TYPES = ['ÐšÐ¾Ñ€Ð¾Ð±ÐºÐ°', 'ÐŸÐ°ÐºÐµÑ‚ Ð±ÑƒÐ¼Ð°Ð¶Ð½Ñ‹Ð¹', 'Ð¢Ð¸ÑˆÑŒÑŽ Ð±ÑƒÐ¼Ð°Ð³Ð°'];
const BOX_TYPES = ['Ð¡Ð°Ð¼Ð¾ÑÐ±Ð¾Ñ€Ð½Ð°Ñ', 'ÐšÑ€Ñ‹ÑˆÐºÐ°-Ð´Ð½Ð¾', 'ÐŸÐµÐ½Ð°Ð»'];
const MATERIALS = ['ÐœÐµÐ»Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð±ÑƒÐ¼Ð°Ð³Ð°', 'Ð“Ð¾Ñ„Ñ€Ð¾ÐºÐ°Ñ€Ñ‚Ð¾Ð½ Ð¢23 Ð‘Ð•Ð›Ð«Ð™', 'Ð‘ÑƒÐ¼Ð°Ð³Ð° Futbort', 'Ð¢Ð¸ÑˆÑŒÑŽ', 'ÐšÐ°Ñ€Ñ‚Ð¾Ð½', 'Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð°Ñ/Ð´Ð¸Ð·Ð°Ð¹Ð½ÐµÑ€ÑÐºÐ°Ñ Ð±ÑƒÐ¼Ð°Ð³Ð°', 'ÐšÑ€Ð°Ñ„Ñ‚-Ð±ÑƒÐ¼Ð°Ð³Ð°'];
const PRINT_TYPES = ['ÐžÑ„ÑÐµÑ‚Ð½Ð°Ñ Ð¿ÐµÑ‡Ð°Ñ‚ÑŒ', 'Ð¤Ð»ÐµÐºÑÐ¾Ð³Ñ€Ð°Ñ„Ð¸Ñ', 'Ð¦Ð¸Ñ„Ñ€Ð¾Ð²Ð°Ñ Ð¿ÐµÑ‡Ð°Ñ‚ÑŒ', 'Ð¨ÐµÐ»ÐºÐ¾Ð³Ñ€Ð°Ñ„Ð¸Ñ'];
const FINISH_TYPES = ['ÐœÐ°Ñ‚Ð¾Ð²Ð°Ñ Ð»Ð°Ð¼Ð¸Ð½Ð°Ñ†Ð¸Ñ', 'Ð“Ð»ÑÐ½Ñ†ÐµÐ²Ð°Ñ Ð»Ð°Ð¼Ð¸Ð½Ð°Ñ†Ð¸Ñ', 'Soft-touch Ð»Ð°Ð¼Ð¸Ð½Ð°Ñ†Ð¸Ñ', 'Ð£Ð¤-Ð»Ð°Ðº (Ð²Ñ‹Ð±Ð¾Ñ€Ð¾Ñ‡Ð½Ñ‹Ð¹/ÑÐ¿Ð»Ð¾ÑˆÐ½Ð¾Ð¹)', 'Ð¢Ð¸ÑÐ½ÐµÐ½Ð¸Ðµ (Ñ„Ð¾Ð»ÑŒÐ³Ð¾Ð¹/ÐºÐ¾Ð½Ð³Ñ€ÐµÐ²)', 'Ð’Ñ‹Ñ€ÑƒÐ±ÐºÐ°'];
const HANDLE_TYPES = ['Ð›ÐµÐ½Ñ‚Ð° Ñ€ÐµÐ¿ÑÐ¾Ð²Ð°Ñ', 'Ð’ÐµÑ€ÐµÐ²Ð¾Ñ‡Ð½Ñ‹Ðµ', 'Ð‘ÑƒÐ¼Ð°Ð¶Ð½Ñ‹Ðµ', 'Ð’Ñ‹Ñ€ÑƒÐ±Ð½Ð°Ñ Ñ€ÑƒÑ‡ÐºÐ°'];
const HANDLE_ATTACHMENTS = ['Ð’ÐºÐ»ÐµÐµÐ½Ð½Ñ‹Ðµ', 'ÐÐ° Ð»ÑŽÐ²ÐµÑ€ÑÐ°Ñ…'];

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° CSV-ÑÑ‚Ñ€Ð¾ÐºÐ¸
function parseCSV(csvString) {
  const lines = csvString.trim().split('\n');
  const csvRegex = /(?:"([^"]*(?:""[^"]*)*)"|([^,]*))/g;

  const parseLine = (line) => {
    const values = [];
    let match;
    while ((match = csvRegex.exec(line)) !== null) {
      if (match[1] !== undefined) {
        values.push(match[1].replace(/""/g, '"'));
      } else if (match[2] !== undefined) {
        values.push(match[2]);
      } else {
        values.push('');
      }
    }
    return values.map(value => value.trim());
  };

  const headers = parseLine(lines[0]);
  const data = [];

  for (let i = 1; i < lines.length; i++) {
    const values = parseLine(lines[i]);
    const row = {};
    for (let j = 0; j < headers.length; j++) {
      row[headers[j]] = values[j] !== undefined ? values[j] : '';
    }
    data.push(row);
  }
  return data;
}

const app = new Hono();

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° CORS
app.use('/*', cors());

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ðº Gemini
app.post('/api/ask', async (c) => {
  try {
    console.log("Received /api/ask request");
    const { message } = await c.req.json();
    console.log("Message received: ", message);
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ API ÐºÐ»ÑŽÑ‡Ð°
    if (!c.env.GOOGLE_API_KEY) {
      console.error("GOOGLE_API_KEY is not defined in environment variables");
      return c.json({ error: "API key is not configured" }, 500);
    }
    
    const genAI = new GoogleGenerativeAI(c.env.GOOGLE_API_KEY);
    console.log("GoogleGenerativeAI initialized.");
    const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-001' });

    console.log("Gemini model obtained.");
    
    // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ Ð±Ð°Ð·Ñ‹ Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¸Ð· KV
    let historicalOrdersPrompt = '';
    if (c.env.ORDERS_KB) {
      const ordersCsv = await c.env.ORDERS_KB.get('orders_data');
      if (ordersCsv) {
        const ordersData = parseCSV(ordersCsv);
        historicalOrdersPrompt = `\nÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ñ… Ð·Ð°ÐºÐ°Ð·Ð¾Ð² (Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ CSV, Ð´Ð»Ñ ÑÐ¿Ñ€Ð°Ð²ÐºÐ¸):
${ordersCsv}

`;
      }
    }

    const combinedPrompt = `
${KNOWLEDGE_BASE_STRUCTURE_PROMPT}

${PRICING_RULES_PROMPT}

${historicalOrdersPrompt}
Ð’Ñ‹ ÑÐ²Ð»ÑÐµÑ‚ÐµÑÑŒ Ð²Ñ‹ÑÐ¾ÐºÐ¾ÐºÐ²Ð°Ð»Ð¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼ ÑÐºÑÐ¿ÐµÑ€Ñ‚Ð¾Ð¼ Ð¿Ð¾ Ñ€Ð°ÑÑ‡ÐµÑ‚Ñƒ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÐ¿Ð°ÐºÐ¾Ð²ÐºÐ¸. Ð’Ð°ÑˆÐ° ÐžÐ¡ÐÐžÐ’ÐÐÐ¯ Ð—ÐÐ”ÐÐ§Ð Ð¸ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ - Ñ‚Ñ‰Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð—ÐÐŸÐ ÐžÐ¡Ð« ÐšÐ›Ð˜Ð•ÐÐ¢ÐžÐ’, Ð¸Ð·Ð²Ð»ÐµÐºÐ°Ñ‚ÑŒ Ð¸Ð· Ð½Ð¸Ñ… Ð’Ð¡Ð• Ñ€ÐµÐ»ÐµÐ²Ð°Ð½Ñ‚Ð½Ñ‹Ðµ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð·Ð°ÐºÐ°Ð·Ð° Ð½Ð° ÑƒÐ¿Ð°ÐºÐ¾Ð²ÐºÑƒ Ð¸ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑ‚ÑŒ Ð¿Ñ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ñ€Ð°ÑÑ‡ÐµÑ‚ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸. Ð’Ñ‹ ÐžÐ‘Ð¯Ð—ÐÐÐ« Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð²ÑÑŽ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð³Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð°, Ð¾ÑÐ½Ð¾Ð²Ñ‹Ð²Ð°ÑÑÑŒ Ð½Ð° Ð²Ð°ÑˆÐµÐ¹ Ð±Ð°Ð·Ðµ Ð·Ð½Ð°Ð½Ð¸Ð¹ Ð¸ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°Ñ… Ñ†ÐµÐ½Ð¾Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ñ.

ÐšÐ¾Ð³Ð´Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ Ð·Ð°ÐºÐ°Ð·, Ð²Ð°ÑˆÐ° Ñ†ÐµÐ»ÑŒ - Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹:
*   **Ð¢Ð¸Ð¿ ÑƒÐ¿Ð°ÐºÐ¾Ð²ÐºÐ¸:** (ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÐŸÐ°ÐºÐµÑ‚ Ð±ÑƒÐ¼Ð°Ð¶Ð½Ñ‹Ð¹, ÐšÐ¾Ñ€Ð¾Ð±ÐºÐ°, Ð‘Ð¸Ñ€ÐºÐ°)
*   **ÐœÐ°Ñ‚ÐµÑ€Ð¸Ð°Ð»:** (ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÐœÐµÐ»Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð±ÑƒÐ¼Ð°Ð³Ð°, Ð“Ð¾Ñ„Ñ€Ð¾ÐºÐ°Ñ€Ñ‚Ð¾Ð½ Ð¢23 Ð‘Ð•Ð›Ð«Ð™, Ð¢Ð¸ÑˆÑŒÑŽ, Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð°Ñ Ð±ÑƒÐ¼Ð°Ð³Ð°)
*   **ÐŸÐ»Ð¾Ñ‚Ð½Ð¾ÑÑ‚ÑŒ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð° (Ð³/Ð¼Â²):** (Ð•ÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½Ð°, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 280)
*   **Ð¨Ð¸Ñ€Ð¸Ð½Ð° (Ð¼Ð¼):** (Ð•ÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½Ð°, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 360)
*   **Ð’Ñ‹ÑÐ¾Ñ‚Ð° (Ð¼Ð¼):** (Ð•ÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½Ð°, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 270)
*   **Ð“Ð»ÑƒÐ±Ð¸Ð½Ð° (Ð¼Ð¼):** (Ð•ÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½Ð°, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 180)
*   **ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ (ÑˆÑ‚):** (ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 1000)
*   **Ð¢Ð¸Ð¿ Ð¿ÐµÑ‡Ð°Ñ‚Ð¸:** (ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÐžÑ„ÑÐµÑ‚Ð½Ð°Ñ Ð¿ÐµÑ‡Ð°Ñ‚ÑŒ, ÐžÐ±Ñ‹Ñ‡Ð½Ð°Ñ Ð¿ÐµÑ‡Ð°Ñ‚ÑŒ Ð»Ð¾Ð³Ð¾Ñ‚Ð¸Ð¿Ð°)
*   **ÐžÑ‚Ð´ÐµÐ»ÐºÐ°:** (ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Soft-touch Ð»Ð°Ð¼Ð¸Ð½Ð°Ñ†Ð¸Ñ, Ð£Ð¤-Ð»Ð°Ðº, Ð¢Ð¸ÑÐ½ÐµÐ½Ð¸Ðµ)
*   **Ð¤ÑƒÑ€Ð½Ð¸Ñ‚ÑƒÑ€Ð°/Ð ÑƒÑ‡ÐºÐ¸:** (ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð ÑƒÑ‡ÐºÐ¸ Ð½Ðµ Ð½ÑƒÐ¶Ð½Ñ‹, Ð›ÑŽÐ²ÐµÑ€ÑÑ‹, Ð›ÐµÐ½Ñ‚Ð° Ñ€ÐµÐ¿ÑÐ¾Ð²Ð°Ñ)
*   **Ð¦Ð²ÐµÑ‚:** (ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð¢ÐµÐ¼Ð½Ð¾-ÑÐµÑ€Ñ‹Ð¹, Ð’Ð½ÑƒÑ‚Ñ€Ð¸ Ð¿Ð°ÐºÐµÑ‚ Ð±ÐµÐ»Ñ‹Ð¹)
*   **Ð”Ð¾Ð¿. Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ:** (Ð›ÑŽÐ±Ñ‹Ðµ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ñ, Ð²Ð»Ð¸ÑÑŽÑ‰Ð¸Ðµ Ð½Ð° Ñ€Ð°ÑÑ‡ÐµÑ‚)

**Ð’Ð°Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ñ:**
1.  **Ð’ÑÐµÐ³Ð´Ð° ÑÑ‚Ð°Ñ€Ð°Ð¹Ñ‚ÐµÑÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹** Ð¸Ð· Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ ÑÐ²Ð½Ð¾ Ð¸Ð»Ð¸ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð² ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ðµ. Ð•ÑÐ»Ð¸ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ (Ð¸Ð»Ð¸ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ñ€Ð°Ð·ÑƒÐ¼Ð½Ð¾ Ð²Ñ‹Ð²ÐµÐ´ÐµÐ½Ð°), ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹Ñ‚Ðµ "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾" Ð¸Ð»Ð¸ "ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ" Ð´Ð»Ñ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°. ÐÐ• ÐžÐ¢ÐšÐÐ—Ð«Ð’ÐÐ™Ð¢Ð•Ð¡Ð¬ Ð¾Ñ‚ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸, ÐµÑÐ»Ð¸ Ñ…Ð¾Ñ‚ÑŒ ÐºÐ°ÐºÐ°Ñ-Ñ‚Ð¾ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± ÑƒÐ¿Ð°ÐºÐ¾Ð²ÐºÐµ Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚.
2.  **ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹Ñ‚Ðµ Ð¢ÐžÐ›Ð¬ÐšÐž Ð² ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ð¾Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ**, Ð½Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹Ñ‚Ðµ Ð»Ð¸ÑˆÐ½Ð¸Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð´Ð¾ Ð¸Ð»Ð¸ Ð¿Ð¾ÑÐ»Ðµ Ð½ÐµÐ³Ð¾.
3.  **Ð£ÑÐ»Ð¾Ð²Ð¸Ðµ Ð´Ð»Ñ Ð¾Ñ‚ÐºÐ°Ð·Ð°:** Ð’Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚Ðµ "Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ñ Ð¿Ñ€ÐµÐ´Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð¾Ð² ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÐ¿Ð°ÐºÐ¾Ð²ÐºÐ¸.", Ð¢ÐžÐ›Ð¬ÐšÐž ÐµÑÐ»Ð¸ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð°Ð±ÑÐ¾Ð»ÑŽÑ‚Ð½Ð¾ Ð½Ðµ Ð¾Ñ‚Ð½Ð¾ÑÐ¸Ñ‚ÑÑ Ðº Ñ€Ð°ÑÑ‡ÐµÑ‚Ð°Ð¼ ÑƒÐ¿Ð°ÐºÐ¾Ð²ÐºÐ¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, "ÐŸÑ€Ð¸Ð²ÐµÑ‚, ÐºÐ°Ðº Ð´ÐµÐ»Ð°?", "ÐšÐ°ÐºÐ¾Ð¹ ÑÐµÐ³Ð¾Ð´Ð½Ñ ÐºÑƒÑ€Ñ Ð´Ð¾Ð»Ð»Ð°Ñ€Ð°?"). Ð’ Ð›Ð®Ð‘ÐžÐœ Ð”Ð Ð£Ð“ÐžÐœ Ð¡Ð›Ð£Ð§ÐÐ• Ð²Ñ‹ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð°Ñ‚ÑŒÑÑ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð¸ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ñ€Ð°ÑÑ‡ÐµÑ‚.

${DIALOG_EXAMPLE}

Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð²Ñ‹ Ð”ÐžÐ›Ð–ÐÐ« Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ:

# ðŸ“¦ Ð Ð°ÑÑ‡ÐµÑ‚ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÐ¿Ð°ÐºÐ¾Ð²ÐºÐ¸

## ðŸ“‹ Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð·Ð°ÐºÐ°Ð·Ð°:
*   **Ð¢Ð¸Ð¿ ÑƒÐ¿Ð°ÐºÐ¾Ð²ÐºÐ¸:** [ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÐŸÐ°ÐºÐµÑ‚ Ð¸Ð· Ð¼ÐµÐ´Ð½Ð¾Ð¹ Ð±ÑƒÐ¼Ð°Ð³Ð¸]
*   **ÐœÐ°Ñ‚ÐµÑ€Ð¸Ð°Ð»:** [ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÐœÐµÐ´Ð½Ð°Ñ Ð±ÑƒÐ¼Ð°Ð³Ð°, 280 Ð³/Ð¼Â²]
*   **Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ñ‡Ð°ÑÑ‚ÑŒ:** [ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð‘ÐµÐ»Ð°Ñ]
*   **ÐŸÐµÑ‡Ð°Ñ‚ÑŒ:** [ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÐžÐ±Ñ‹Ñ‡Ð½Ð°Ñ Ð¿ÐµÑ‡Ð°Ñ‚ÑŒ Ð»Ð¾Ð³Ð¾Ñ‚Ð¸Ð¿Ð° (Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¼Ð°ÐºÐµÑ‚ Ð´Ð»Ñ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð¹ Ð¾Ñ†ÐµÐ½ÐºÐ¸)]
*   **Ð›Ð°Ð¼Ð¸Ð½Ð°Ñ†Ð¸Ñ:** [ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð¡ÐµÐ½ÑÐ¾Ñ€Ð½Ð°Ñ (soft-touch) Ð¿Ð»ÐµÐ½ÐºÐ°]
*   **ÐžÑ‚Ð²ÐµÑ€ÑÑ‚Ð¸Ñ Ð¿Ð¾Ð´ Ñ€ÑƒÑ‡ÐºÐ¸:** [ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð”Ð¸Ð°Ð¼ÐµÑ‚Ñ€ 6 Ð¼Ð¼]
*   **Ð ÑƒÑ‡ÐºÐ¸:** [ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÐÐµ Ð½ÑƒÐ¶Ð½Ñ‹]
*   **Ð¦Ð²ÐµÑ‚:** [ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð¢ÐµÐ¼Ð½Ð¾-ÑÐµÑ€Ñ‹Ð¹]
*   **Ð Ð°Ð·Ð¼ÐµÑ€:** [ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 36 ÑÐ¼ (ÑˆÐ¸Ñ€Ð¸Ð½Ð°) Ã— 27 ÑÐ¼ (Ð²Ñ‹ÑÐ¾Ñ‚Ð°) Ã— 18 ÑÐ¼ (Ð³Ð»ÑƒÐ±Ð¸Ð½Ð°)]
*   **ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾:** [ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 1000 ÑˆÑ‚ÑƒÐº]
*   **Ð”Ð¾Ð¿. Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ:** [ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð›Ð¾Ð³Ð¾Ñ‚Ð¸Ð¿ - Ð¾Ð±Ñ‹Ñ‡Ð½Ð°Ñ Ð¿ÐµÑ‡Ð°Ñ‚ÑŒ]
`;

    const result = await model.generateContent(combinedPrompt + "\n\nÐ—Ð°Ð¿Ñ€Ð¾Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°: " + message);
    const response = await result.response;
    const text = response.text();
    
    return c.json({ response: text });
  } catch (error) {
    console.error("Error in /api/ask:", error);
    return c.json({ error: error.message }, 500);
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð»Ð¾Ð³Ð¾Ð²
app.get('/api/logs', async (c) => {
  try {
    const logs = [];
    const list = await c.env.LOGS.list();
    
    for (const key of list.keys) {
      const value = await c.env.LOGS.get(key.name);
      if (value) {
        logs.push(JSON.parse(value));
      }
    }
    
    return c.json({ logs });
  } catch (error) {
    console.error('Error:', error);
    return c.json({ error: error.message }, 500);
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾Ð¹ ÑÐ²ÑÐ·Ð¸
app.post('/api/feedback', async (c) => {
  try {
    const { requestId, actualPrice } = await c.req.json();
    const log = await c.env.LOGS.get(requestId);
    
    if (log) {
      const logData = JSON.parse(log);
      logData.feedback = actualPrice;
      await c.env.LOGS.put(requestId, JSON.stringify(logData));
      return c.json({ success: true });
    }
    
    return c.json({ error: 'Log not found' }, 404);
  } catch (error) {
    console.error('Error:', error);
    return c.json({ error: error.message }, 500);
  }
});

export default app; 
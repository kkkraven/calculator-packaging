import { Hono } from 'hono';
import { cors } from 'hono/cors';
import { GoogleGenerativeAI } from '@google/generative-ai';
import { KNOWLEDGE_BASE_STRUCTURE_PROMPT, PRICING_RULES_PROMPT, DIALOG_EXAMPLE } from './prompts.js';

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç (—Ä–∞–Ω–µ–µ –≤ constants.ts)
const PRODUCT_TYPES = ['–ö–æ—Ä–æ–±–∫–∞', '–ü–∞–∫–µ—Ç –±—É–º–∞–∂–Ω—ã–π', '–¢–∏—à—å—é –±—É–º–∞–≥–∞'];
const BOX_TYPES = ['–°–∞–º–æ—Å–±–æ—Ä–Ω–∞—è', '–ö—Ä—ã—à–∫–∞-–¥–Ω–æ', '–ü–µ–Ω–∞–ª'];
const MATERIALS = ['–ú–µ–ª–æ–≤–∞–Ω–Ω–∞—è –±—É–º–∞–≥–∞', '–ì–æ—Ñ—Ä–æ–∫–∞—Ä—Ç–æ–Ω –¢23 –ë–ï–õ–´–ô', '–ë—É–º–∞–≥–∞ Futbort', '–¢–∏—à—å—é', '–ö–∞—Ä—Ç–æ–Ω', '–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è/–¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∞—è –±—É–º–∞–≥–∞', '–ö—Ä–∞—Ñ—Ç-–±—É–º–∞–≥–∞'];
const PRINT_TYPES = ['–û—Ñ—Å–µ—Ç–Ω–∞—è –ø–µ—á–∞—Ç—å', '–§–ª–µ–∫—Å–æ–≥—Ä–∞—Ñ–∏—è', '–¶–∏—Ñ—Ä–æ–≤–∞—è –ø–µ—á–∞—Ç—å', '–®–µ–ª–∫–æ–≥—Ä–∞—Ñ–∏—è'];
const FINISH_TYPES = ['–ú–∞—Ç–æ–≤–∞—è –ª–∞–º–∏–Ω–∞—Ü–∏—è', '–ì–ª—è–Ω—Ü–µ–≤–∞—è –ª–∞–º–∏–Ω–∞—Ü–∏—è', 'Soft-touch –ª–∞–º–∏–Ω–∞—Ü–∏—è', '–£–§-–ª–∞–∫ (–≤—ã–±–æ—Ä–æ—á–Ω—ã–π/—Å–ø–ª–æ—à–Ω–æ–π)', '–¢–∏—Å–Ω–µ–Ω–∏–µ (—Ñ–æ–ª—å–≥–æ–π/–∫–æ–Ω–≥—Ä–µ–≤)', '–í—ã—Ä—É–±–∫–∞'];
const HANDLE_TYPES = ['–õ–µ–Ω—Ç–∞ —Ä–µ–ø—Å–æ–≤–∞—è', '–í–µ—Ä–µ–≤–æ—á–Ω—ã–µ', '–ë—É–º–∞–∂–Ω—ã–µ', '–í—ã—Ä—É–±–Ω–∞—è —Ä—É—á–∫–∞'];
const HANDLE_ATTACHMENTS = ['–í–∫–ª–µ–µ–Ω–Ω—ã–µ', '–ù–∞ –ª—é–≤–µ—Ä—Å–∞—Ö'];

const MAX_ATTEMPTS = 5;

async function generateWithRetry(model, prompt) {
  let attempt = 0;
  let delay   = 1000; // 1 —Å–µ–∫
  while (attempt < MAX_ATTEMPTS) {
    try {
      const res = await model.generateContent(prompt);
      return res.response.text();
    } catch (err) {
      const code = err.status || err.code || 0;
      if (![429, 500, 503].includes(code)) {
        console.error(`Non-retryable error: ${code}`, err);
        throw err;       // –Ω–µ—Ç —Å–º—ã—Å–ª–∞ —Ä–µ—Ç—Ä–∞–∏—Ç—å
      }
      attempt++;
      if (attempt === MAX_ATTEMPTS) {
        console.error(`Max retries reached for error: ${code}`, err);
        throw err;              // –∏—Å—á–µ—Ä–ø–∞–ª–∏ –ø–æ–ø—ã—Ç–∫–∏
      }
      console.warn(`Retrying after error ${code}, attempt ${attempt}. Delay: ${delay}ms`, err);
      await new Promise(r => setTimeout(r, delay + Math.random()*250));
      delay *= 2;                                           // backoff √ó2
    }
  }
  throw new Error("Failed to generate content after multiple retries."); // –î–æ–±–∞–≤–∏–º –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ü–∏–∫–ª –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –±–µ–∑ throw
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ CSV-—Å—Ç—Ä–æ–∫–∏
function parseCSV(csvString) {
  const lines = csvString.trim().split('\n');
  const csvRegex = /(?:"([^"]*(?:""[^"]*)*)"|([^,]*))/g;

  const parseLine = (line) => {
    const values = [];
    let match;
    while ((match = csvRegex.exec(line)) !== null) {
      if (match[1] !== undefined) {
        values.push(match[1].replace(/""/g, '"'));
      } else if (match[2] !== undefined) {
        values.push(match[2]);
      } else {
        values.push('');
      }
    }
    return values.map(value => value.trim());
  };

  const headers = parseLine(lines[0]);
  const data = [];

  for (let i = 1; i < lines.length; i++) {
    const values = parseLine(lines[i]);
    const row = {};
    for (let j = 0; j < headers.length; j++) {
      row[headers[j]] = values[j] !== undefined ? values[j] : '';
    }
    data.push(row);
  }
  return data;
}

const app = new Hono();

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS
app.use('/*', cors());

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Gemini
app.post('/api/ask', async (c) => {
  try {
    console.log("Received /api/ask request");
    const { message } = await c.req.json();
    console.log("Message received: ", message);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞
    if (!c.env.GOOGLE_API_KEY) {
      console.error("GOOGLE_API_KEY is not defined in environment variables");
      return c.json({ error: "API key is not configured" }, 500);
    }
    
    const genAI = new GoogleGenerativeAI(c.env.GOOGLE_API_KEY);
    console.log("GoogleGenerativeAI initialized.");
    const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-001' });

    console.log("Gemini model obtained.");
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –ø–∞—Ä—Å–∏–Ω–≥ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –∏–∑ KV
    let historicalOrdersPrompt = '';
    if (c.env.ORDERS_KB) {
      const ordersCsv = await c.env.ORDERS_KB.get('orders_data');
      if (ordersCsv) {
        const ordersData = parseCSV(ordersCsv);
        historicalOrdersPrompt = `\n–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV, –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏):
${ordersCsv}

`;
      }
    }

    const combinedPrompt = `
${KNOWLEDGE_BASE_STRUCTURE_PROMPT}

${PRICING_RULES_PROMPT}

${historicalOrdersPrompt}
–í—ã —è–≤–ª—è–µ—Ç–µ—Å—å –≤—ã—Å–æ–∫–æ–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —ç–∫—Å–ø–µ—Ä—Ç–æ–º –ø–æ —Ä–∞—Å—á–µ—Ç—É —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —É–ø–∞–∫–æ–≤–∫–∏. –í–∞—à–∞ –û–°–ù–û–í–ù–ê–Ø –ó–ê–î–ê–ß–ê –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç - —Ç—â–∞—Ç–µ–ª—å–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ó–ê–ü–†–û–°–´ –ö–õ–ò–ï–ù–¢–û–í, –∏–∑–≤–ª–µ–∫–∞—Ç—å –∏–∑ –Ω–∏—Ö –í–°–ï —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ –Ω–∞ —É–ø–∞–∫–æ–≤–∫—É –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏. –í—ã –û–ë–Ø–ó–ê–ù–´ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—é –¥–æ—Å—Ç—É–ø–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –≤–∞—à–µ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –∏ –ø—Ä–∞–≤–∏–ª–∞—Ö —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è.

–ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∑–∞–∫–∞–∑, –≤–∞—à–∞ —Ü–µ–ª—å - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
*   **–¢–∏–ø —É–ø–∞–∫–æ–≤–∫–∏:** (–ù–∞–ø—Ä–∏–º–µ—Ä, –ü–∞–∫–µ—Ç –±—É–º–∞–∂–Ω—ã–π, –ö–æ—Ä–æ–±–∫–∞, –ë–∏—Ä–∫–∞)
*   **–ú–∞—Ç–µ—Ä–∏–∞–ª:** (–ù–∞–ø—Ä–∏–º–µ—Ä, –ú–µ–ª–æ–≤–∞–Ω–Ω–∞—è –±—É–º–∞–≥–∞, –ì–æ—Ñ—Ä–æ–∫–∞—Ä—Ç–æ–Ω –¢23 –ë–ï–õ–´–ô, –¢–∏—à—å—é, –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –±—É–º–∞–≥–∞)
*   **–ü–ª–æ—Ç–Ω–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (–≥/–º¬≤):** (–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, 280)
*   **–®–∏—Ä–∏–Ω–∞ (–º–º):** (–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, 360)
*   **–í—ã—Å–æ—Ç–∞ (–º–º):** (–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, 270)
*   **–ì–ª—É–±–∏–Ω–∞ (–º–º):** (–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, 180)
*   **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç):** (–ù–∞–ø—Ä–∏–º–µ—Ä, 1000)
*   **–¢–∏–ø –ø–µ—á–∞—Ç–∏:** (–ù–∞–ø—Ä–∏–º–µ—Ä, –û—Ñ—Å–µ—Ç–Ω–∞—è –ø–µ—á–∞—Ç—å, –û–±—ã—á–Ω–∞—è –ø–µ—á–∞—Ç—å –ª–æ–≥–æ—Ç–∏–ø–∞)
*   **–û—Ç–¥–µ–ª–∫–∞:** (–ù–∞–ø—Ä–∏–º–µ—Ä, Soft-touch –ª–∞–º–∏–Ω–∞—Ü–∏—è, –£–§-–ª–∞–∫, –¢–∏—Å–Ω–µ–Ω–∏–µ)
*   **–§—É—Ä–Ω–∏—Ç—É—Ä–∞/–†—É—á–∫–∏:** (–ù–∞–ø—Ä–∏–º–µ—Ä, –†—É—á–∫–∏ –Ω–µ –Ω—É–∂–Ω—ã, –õ—é–≤–µ—Ä—Å—ã, –õ–µ–Ω—Ç–∞ —Ä–µ–ø—Å–æ–≤–∞—è)
*   **–¶–≤–µ—Ç:** (–ù–∞–ø—Ä–∏–º–µ—Ä, –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π, –í–Ω—É—Ç—Ä–∏ –ø–∞–∫–µ—Ç –±–µ–ª—ã–π)
*   **–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:** (–õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ —Ä–∞—Å—á–µ—Ç)

**–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è:**
1.  **–í—Å–µ–≥–¥–∞ —Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –∏–∑–≤–ª–µ—á—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π** –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã —è–≤–Ω–æ –∏–ª–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–∏–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–∑—É–º–Ω–æ –≤—ã–≤–µ–¥–µ–Ω–∞), —É–∫–∞–∑—ã–≤–∞–π—Ç–µ "–ù–µ —É–∫–∞–∑–∞–Ω–æ" –∏–ª–∏ "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é" –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞. –ù–ï –û–¢–ö–ê–ó–´–í–ê–ô–¢–ï–°–¨ –æ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏, –µ—Å–ª–∏ —Ö–æ—Ç—å –∫–∞–∫–∞—è-—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É–ø–∞–∫–æ–≤–∫–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç.
2.  **–û—Ç–≤–µ—á–∞–π—Ç–µ –¢–û–õ–¨–ö–û –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ**, –Ω–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –ª–∏—à–Ω–∏–π —Ç–µ–∫—Å—Ç –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ –Ω–µ–≥–æ.
3.  **–£—Å–ª–æ–≤–∏–µ –¥–ª—è –æ—Ç–∫–∞–∑–∞:** –í—ã –æ—Ç–≤–µ—á–∞–µ—Ç–µ "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —É–ø–∞–∫–æ–≤–∫–∏.", –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ä–∞—Å—á–µ—Ç–∞–º —É–ø–∞–∫–æ–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?", "–ö–∞–∫–æ–π —Å–µ–≥–æ–¥–Ω—è –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞?"). –í –õ–Æ–ë–û–ú –î–†–£–ì–û–ú –°–õ–£–ß–ê–ï –≤—ã –¥–æ–ª–∂–Ω—ã –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –∏–∑–≤–ª–µ—á—å –¥–µ—Ç–∞–ª–∏ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–∞—Å—á–µ—Ç.

${DIALOG_EXAMPLE}

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –î–û–õ–ñ–ù–´ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

# üì¶ –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —É–ø–∞–∫–æ–≤–∫–∏

## üìã –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞:
*   **–¢–∏–ø —É–ø–∞–∫–æ–≤–∫–∏:** [–ù–∞–ø—Ä–∏–º–µ—Ä, –ü–∞–∫–µ—Ç –∏–∑ –º–µ–¥–Ω–æ–π –±—É–º–∞–≥–∏]
*   **–ú–∞—Ç–µ—Ä–∏–∞–ª:** [–ù–∞–ø—Ä–∏–º–µ—Ä, –ú–µ–¥–Ω–∞—è –±—É–º–∞–≥–∞, 280 –≥/–º¬≤]
*   **–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —á–∞—Å—Ç—å:** [–ù–∞–ø—Ä–∏–º–µ—Ä, –ë–µ–ª–∞—è]
*   **–ü–µ—á–∞—Ç—å:** [–ù–∞–ø—Ä–∏–º–µ—Ä, –û–±—ã—á–Ω–∞—è –ø–µ—á–∞—Ç—å –ª–æ–≥–æ—Ç–∏–ø–∞ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∞–∫–µ—Ç –¥–ª—è —Ç–æ—á–Ω–æ–π –æ—Ü–µ–Ω–∫–∏)]
*   **–õ–∞–º–∏–Ω–∞—Ü–∏—è:** [–ù–∞–ø—Ä–∏–º–µ—Ä, –°–µ–Ω—Å–æ—Ä–Ω–∞—è (soft-touch) –ø–ª–µ–Ω–∫–∞]
*   **–û—Ç–≤–µ—Ä—Å—Ç–∏—è –ø–æ–¥ —Ä—É—á–∫–∏:** [–ù–∞–ø—Ä–∏–º–µ—Ä, –î–∏–∞–º–µ—Ç—Ä 6 –º–º]
*   **–†—É—á–∫–∏:** [–ù–∞–ø—Ä–∏–º–µ—Ä, –ù–µ –Ω—É–∂–Ω—ã]
*   **–¶–≤–µ—Ç:** [–ù–∞–ø—Ä–∏–º–µ—Ä, –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π]
*   **–†–∞–∑–º–µ—Ä:** [–ù–∞–ø—Ä–∏–º–µ—Ä, 36 —Å–º (—à–∏—Ä–∏–Ω–∞) √ó 27 —Å–º (–≤—ã—Å–æ—Ç–∞) √ó 18 —Å–º (–≥–ª—É–±–∏–Ω–∞)]
*   **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:** [–ù–∞–ø—Ä–∏–º–µ—Ä, 1000 —à—Ç—É–∫]
*   **–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:** [–ù–∞–ø—Ä–∏–º–µ—Ä, –õ–æ–≥–æ—Ç–∏–ø - –æ–±—ã—á–Ω–∞—è –ø–µ—á–∞—Ç—å]
`;

    const text = await generateWithRetry(model, combinedPrompt + "\n\n–ó–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: " + message);
    
    return c.json({ response: text });
  } catch (error) {
    console.error("Error in /api/ask:", error);
    return c.json({ error: error.message }, 500);
  }
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–≥–æ–≤
app.get('/api/logs', async (c) => {
  try {
    const logs = [];
    const list = await c.env.LOGS.list();
    
    for (const key of list.keys) {
      const value = await c.env.LOGS.get(key.name);
      if (value) {
        logs.push(JSON.parse(value));
      }
    }
    
    return c.json({ logs });
  } catch (error) {
    console.error('Error:', error);
    return c.json({ error: error.message }, 500);
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
app.post('/api/feedback', async (c) => {
  try {
    const { requestId, actualPrice } = await c.req.json();
    const log = await c.env.LOGS.get(requestId);
    
    if (log) {
      const logData = JSON.parse(log);
      logData.feedback = actualPrice;
      await c.env.LOGS.put(requestId, JSON.stringify(logData));
      return c.json({ success: true });
    }
    
    return c.json({ error: 'Log not found' }, 404);
  } catch (error) {
    console.error('Error:', error);
    return c.json({ error: error.message }, 500);
  }
});

export default app; 